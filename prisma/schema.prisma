// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?          // <- use password, optional
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaignMemberships CampaignMembership[]
  characters          Character[]
  playerActions       PlayerAction[]
  createInvites       CampaignInvite[] @relation("InviteCreator")
}

model Campaign {
  id               String   @id @default(cuid())
  title            String
  description      String?
  universe         String? // e.g., "MHA", "Cosmere", "Original"
  aiSystemPrompt   String   @db.Text
  initialWorldSeed String   @db.Text
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  memberships CampaignMembership[]
  characters  Character[]
  npcs        NPC[]
  factions    Faction[]
  clocks      Clock[]
  scenes      Scene[]
  timeline    TimelineEvent[]
  worldMeta   WorldMeta?
  invites     CampaignInvite[]
}

model CampaignMembership {
  id         String   @id @default(cuid())
  userId     String
  campaignId String
  role       String   @default("player") // "admin", "player"
  joinedAt   DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([userId, campaignId])
}

model Character {
  id              String   @id @default(cuid())
  campaignId      String
  userId          String
  name            String
  pronouns        String?
  description     String?
  stats           Json? // Flexible stats object
  backstory       String?
  goals           String?
  isAlive         Boolean  @default(true)
  currentLocation String?
  gmNotes         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campaign      Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  playerActions PlayerAction[]

  @@index([campaignId])
  @@index([userId])
}

model NPC {
  id              String   @id @default(cuid())
  campaignId      String
  name            String
  pronouns        String?
  description     String?
  currentLocation String?
  goals           String?
  relationship    String? // relationship to PCs or world
  isAlive         Boolean  @default(true)
  importance      Int      @default(1) // 1-5 scale
  gmNotes         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

model Faction {
  id            String   @id @default(cuid())
  campaignId    String
  name          String
  description   String?
  goals         String?
  resources     Int      @default(50) // 0-100 scale
  influence     Int      @default(50) // 0-100 scale
  currentPlan   String?
  threatLevel   Int      @default(1) // 1-5 scale
  relationships Json? // Relations to other factions/PCs
  gmNotes       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

model Clock {
  id          String   @id @default(cuid())
  campaignId  String
  name        String
  description String?
  segments    Int      @default(4)
  filled      Int      @default(0)
  category    String? // "threat", "opportunity", "countdown", etc.
  isHidden    Boolean  @default(false) // Hidden from players
  triggersAt  Int? // Auto-trigger when this many segments filled
  gmNotes     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

model Scene {
  id          String   @id @default(cuid())
  campaignId  String
  sceneNumber Int
  title       String?
  framing     String   @db.Text // AI's scene setup
  location    String?
  participants Json? // Array of character/NPC IDs present
  status      String   @default("active") // "active", "resolved", "paused"
  resolution  String?  @db.Text // How the scene concluded
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign      Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  playerActions PlayerAction[]

  @@index([campaignId])
  @@index([status])
}

model PlayerAction {
  id            String   @id @default(cuid())
  sceneId       String
  characterId   String
  userId        String
  actionText    String   @db.Text
  intentOutcome String? // What the player hopes to achieve
  status        String   @default("pending") // "pending", "resolved"
  resolution    String?  @db.Text // AI's resolution of this action
  rollResult    Json? // If using dice mechanics
  createdAt     DateTime @default(now())

  scene     Scene     @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sceneId])
  @@index([characterId])
}

model TimelineEvent {
  id          String   @id @default(cuid())
  campaignId  String
  sessionDate DateTime @default(now())
  title       String
  summary     String   @db.Text
  eventType   String? // "scene", "downtime", "timeskip", "world_event"
  visibility  String   @default("public") // "public", "hidden"
  gmNotes     String?
  createdAt   DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([sessionDate])
}

model WorldMeta {
  id              String   @id @default(cuid())
  campaignId      String   @unique
  currentDate     String? // In-world date/time
  currentLocation String? // Primary focus location
  tension         Int      @default(50) // 0-100 overall tension
  phase           String? // "introduction", "rising_action", "climax", etc.
  customFlags     Json? // Flexible storage for campaign-specific data
  gmNotes         String?
  updatedAt       DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model CampaignInvite {
  id        String   @id @default(cuid())
  campaignId String
  token     String   @unique @default(cuid())
  createdBy String
  expiresAt DateTime
  maxUses   Int      @default(0) // 0 = unlimited
  uses      Int      @default(0)
  createdAt DateTime @default(now())

  campaign  Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  createdByUser User @relation("InviteCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([campaignId])
}
