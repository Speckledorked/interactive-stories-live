generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS — must match your existing code usage
//

enum SceneStatus {
  AWAITING_ACTIONS
  RESOLVING
  RESOLVED
}

enum EventVisibility {
  PUBLIC
  GM_ONLY
  MIXED
}

enum EventType {
  SCENE
  DOWNTIME
  TIMESKIP
  WORLD_EVENT
}

enum UserRole {
  ADMIN
  PLAYER
}

//
// USER & MEMBERSHIP
//

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaignMemberships CampaignMembership[]
  characters          Character[]
  playerActions       PlayerAction[]
  createInvites       CampaignInvite[] @relation("InviteCreator")
}

model CampaignMembership {
  id         String   @id @default(cuid())
  userId     String
  campaignId String
  role       UserRole @default(PLAYER)
  joinedAt   DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([userId, campaignId])
}

//
// CAMPAIGN ROOT
//

model Campaign {
  id               String   @id @default(cuid())
  title            String
  description      String?
  universe         String?
  aiSystemPrompt   String   @db.Text
  initialWorldSeed String   @db.Text
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  memberships CampaignMembership[]
  characters  Character[]
  npcs        NPC[]
  factions    Faction[]
  clocks      Clock[]
  scenes      Scene[]
  timeline    TimelineEvent[]
  worldMeta   WorldMeta?
  invites     CampaignInvite[]
}

//
// CHARACTERS
//

model Character {
  id              String   @id @default(cuid())
  campaignId      String
  userId          String
  name            String
  pronouns        String?
  description     String?
  stats           Json?
  backstory       String?
  goals           String?
  isAlive         Boolean  @default(true)
  currentLocation String?
  gmNotes         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campaign      Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  playerActions PlayerAction[]

  @@index([campaignId])
  @@index([userId])
}

//
// NPCs & FACTIONS
//

model NPC {
  id              String   @id @default(cuid())
  campaignId      String
  name            String
  pronouns        String?
  description     String?
  currentLocation String?
  goals           String?
  relationship    String?
  isAlive         Boolean  @default(true)
  importance      Int      @default(1)
  gmNotes         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

model Faction {
  id            String   @id @default(cuid())
  campaignId    String
  name          String
  description   String?
  goals         String?
  resources     Int      @default(50)
  influence     Int      @default(50)
  currentPlan   String?
  threatLevel   Int      @default(1)
  relationships Json?
  gmNotes       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

//
// CLOCKS — FULL feature version
//

model Clock {
  id            String   @id @default(cuid())
  campaignId    String
  name          String
  description   String?
  currentTicks  Int      @default(0)     // required by worldTurn + stateUpdater
  maxTicks      Int      @default(4)     // required by code
  category      String?
  isHidden      Boolean  @default(false)
  consequence   String?                 // triggered result
  gmNotes       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

//
// SCENES — FULL feature version
//

model Scene {
  id                 String      @id @default(cuid())
  campaignId         String
  sceneNumber        Int
  title              String?
  sceneIntroText     String      @db.Text       // required by createNewScene()
  framing            String?     @db.Text       // optional alternative, preserved
  location           String?
  participants       Json?
  status             SceneStatus @default(AWAITING_ACTIONS)
  sceneResolutionText String?    @db.Text
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  campaign      Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  playerActions PlayerAction[]

  @@index([campaignId])
  @@index([status])
}

//
// PLAYER ACTIONS
//

model PlayerAction {
  id            String   @id @default(cuid())
  sceneId       String
  characterId   String
  userId        String
  actionText    String   @db.Text
  intentOutcome String?
  status        String   @default("pending")
  resolution    String?  @db.Text
  rollResult    Json?
  createdAt     DateTime @default(now())

  scene     Scene     @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sceneId])
  @@index([characterId])
}

//
// TIMELINE — FULL feature version
//

model TimelineEvent {
  id             String          @id @default(cuid())
  campaignId     String
  turnNumber     Int?                              // required by world turn + UI
  title          String
  summaryPublic  String?        @db.Text
  summaryGM      String?        @db.Text
  isOffscreen    Boolean?       @default(false)
  eventType      EventType?
  visibility     EventVisibility @default(PUBLIC)
  sessionDate    DateTime        @default(now())
  gmNotes        String?
  createdAt      DateTime        @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([turnNumber])
}

//
// WORLD META — FULL feature version
//

model WorldMeta {
  id               String   @id @default(cuid())
  campaignId       String   @unique
  currentTurnNumber Int      @default(1)
  currentInGameDate String?
  currentLocation   String?
  tension           Int      @default(50)
  phase             String?
  otherMeta         Json?
  gmNotes           String?
  updatedAt         DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

//
// INVITES
//

model CampaignInvite {
  id         String   @id @default(cuid())
  campaignId String
  token      String   @unique @default(cuid())
  createdBy  String
  expiresAt  DateTime
  maxUses    Int      @default(0)
  uses       Int      @default(0)
  createdAt  DateTime @default(now())

  campaign       Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  createdByUser  User     @relation("InviteCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([campaignId])
}
