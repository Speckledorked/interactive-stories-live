generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS — must match your existing code usage
//

enum SceneStatus {
  AWAITING_ACTIONS
  RESOLVING
  RESOLVED
}

enum EventVisibility {
  PUBLIC
  GM_ONLY
  MIXED
}

enum EventType {
  SCENE
  DOWNTIME
  TIMESKIP
  WORLD_EVENT
}

enum UserRole {
  ADMIN
  PLAYER
}

// Phase 8: Communication enums
enum MessageType {
  IN_CHARACTER
  OUT_OF_CHARACTER
  WHISPER
  SYSTEM
}

enum NoteVisibility {
  PRIVATE
  GM
  SHARED
}

// Phase 9: Notification enums
enum NotificationType {
  TURN_REMINDER
  SCENE_CHANGE
  MENTION
  WHISPER_RECEIVED
  NOTE_SHARED
  CAMPAIGN_INVITE
  SCENE_RESOLVED
  AI_RESPONSE_READY
  WORLD_EVENT
}

enum NotificationStatus {
  UNREAD
  READ
  DISMISSED
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

//
// USER & MEMBERSHIP
//

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Payment system - balance stored in cents (e.g., 100 = $1.00)
  balance   Int      @default(0)

  // Phase 9: Online status
  lastSeenAt DateTime?
  isOnline   Boolean  @default(false)

  campaignMemberships CampaignMembership[]
  characters          Character[]
  playerActions       PlayerAction[]
  createInvites       CampaignInvite[] @relation("InviteCreator")
  diceRolls           DiceRoll[]

  // Phase 8: Communication
  sentMessages     Message[]    @relation("UserMessages")
  receivedWhispers Message[]    @relation("UserWhispers")
  notes            PlayerNote[] @relation("UserNotes")

  // Phase 9: Notifications
  notifications        Notification[]            @relation("UserNotifications")
  notificationSettings UserNotificationSettings? @relation("UserNotificationSettings")
}

model CampaignMembership {
  id         String   @id @default(cuid())
  userId     String
  campaignId String
  role       UserRole @default(PLAYER)
  joinedAt   DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([userId, campaignId])
}

//
// CAMPAIGN ROOT
//

model Campaign {
  id               String   @id @default(cuid())
  title            String
  description      String?
  universe         String?
  aiSystemPrompt   String   @db.Text
  initialWorldSeed String   @db.Text
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Phase 9: Campaign notification settings
  mentionsEnabled      Boolean @default(true)
  soundEffectsEnabled  Boolean @default(true)

  memberships CampaignMembership[]
  characters  Character[]
  npcs        NPC[]
  factions    Faction[]
  clocks      Clock[]
  scenes      Scene[]
  timeline    TimelineEvent[]
  worldMeta   WorldMeta?
  invites     CampaignInvite[]
  moves       Move[]
  diceRolls   DiceRoll[]

  // Phase 8: Communication
  messages Message[]    @relation("CampaignMessages")
  notes    PlayerNote[] @relation("CampaignNotes")

  // Phase 9: Notifications
  notifications Notification[] @relation("CampaignNotifications")
  turnTracker   TurnTracker[]  @relation("CampaignTurnTracker")
}

//
// CHARACTERS
//

model Character {
  id              String   @id @default(cuid())
  campaignId      String
  userId          String
  name            String
  pronouns        String?
  description     String?
  appearance      String?  // Physical appearance
  personality     String?  // Personality traits and demeanor
  stats           Json? // For PbtA: {cool: 1, hard: 2, hot: -1, sharp: 1, weird: 0}
  backstory       String?
  goals           String?
  isAlive         Boolean  @default(true)
  currentLocation String?
  gmNotes         String?

  // PbtA specific fields
  harm            Int      @default(0) // 0-6 harm track
  experience      Int      @default(0) // XP counter
  conditions      Json?    // { conditions: [{ id, name, category, description, mechanicalEffect?, appliedAt? }] }
  moves           String[] // Character move IDs they've unlocked
  holds           Json?    // Temporary holds/forward from moves

  // Organic growth tracking
  statUsage       Json? // { [statKey: string]: { uses: Int, successes: Int, failures: Int } }
  perks           Json? // [{ id, name, description, tags? }]
  advancementLog  Json? // { entries: [], totalStatIncreases, totalPerksGained, totalMovesLearned }

  // Inventory and equipment
  inventory       Json? // { items: [{ id, name, quantity?, tags? }], slots?: number }
  equipment       Json? // { weapon?: {...}, armor?: {...}, misc?: [...] }
  resources       Json? // { gold?: number, reputation?: { [factionId: string]: number }, contacts?: string[] }

  // Phase 14: Relationships and consequences (HIDDEN from players)
  relationships   Json? // { [entityId: string]: { trust: Int, tension: Int, respect: Int, fear: Int } }
  consequences    Json? // { promises?: string[], debts?: string[], enemies?: string[], longTermThreats?: string[] }

  // Phase 16: Zone-based positioning
  currentZone     String? // "close", "near", "far", "distant"
  zoneMetadata    Json?   // { customZones?: string[], zoneEffects?: object }

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campaign      Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  playerActions PlayerAction[]
  diceRolls     DiceRoll[]
  turnOrders    TurnOrder[]

  // Phase 8: Communication
  messages Message[]    @relation("CharacterMessages")
  notes    PlayerNote[] @relation("CharacterNotes")

  @@index([campaignId])
  @@index([userId])
}

//
// NPCs & FACTIONS
//

model NPC {
  id              String   @id @default(cuid())
  campaignId      String
  name            String
  pronouns        String?
  description     String?
  currentLocation String?
  goals           String?
  relationship    String?
  isAlive         Boolean  @default(true)
  importance      Int      @default(1)
  gmNotes         String?

  // PbtA fields for significant NPCs
  threat          String?  // Type of threat (warlord, grotesque, landscape, etc)
  impulses        String[] // What drives this NPC
  moves           String[] // Custom moves this NPC can trigger

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Phase 8: Communication
  notes PlayerNote[] @relation("NPCNotes")

  @@index([campaignId])
}

model Faction {
  id            String   @id @default(cuid())
  campaignId    String
  name          String
  description   String?
  goals         String?
  resources     Int      @default(50)
  influence     Int      @default(50)
  currentPlan   String?
  threatLevel   Int      @default(1)
  relationships Json?
  gmNotes       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Phase 8: Communication
  notes PlayerNote[] @relation("FactionNotes")

  @@index([campaignId])
}

//
// CLOCKS — FULL feature version
//

model Clock {
  id            String   @id @default(cuid())
  campaignId    String
  name          String
  description   String?
  currentTicks  Int      @default(0)     // required by worldTurn + stateUpdater
  maxTicks      Int      @default(4)     // required by code
  category      String?
  isHidden      Boolean  @default(false)
  consequence   String?                 // triggered result
  gmNotes       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

//
// SCENES — FULL feature version
//

model Scene {
  id                 String      @id @default(cuid())
  campaignId         String
  sceneNumber        Int
  title              String?
  sceneIntroText     String      @db.Text       // required by createNewScene()
  framing            String?     @db.Text       // optional alternative, preserved
  location           String?
  participants       Json?
  status             SceneStatus @default(AWAITING_ACTIONS)
  sceneResolutionText String?    @db.Text

  // PbtA scene tracking
  sceneType          String?     @default("dramatic") // "dramatic", "downtime", "combat"
  stakes             String?     // What's at risk in this scene

  // Phase 16: Freeform Combat & Exchange System
  combatMode         String?     @default("freeform") // "freeform", "structured"
  exchangeState      Json?       // { playersActed: string[], exchangeNumber: number, isComplete: boolean, complexity: 'simple' | 'complex' }
  currentExchange    Int         @default(0)

  // Phase 14: Consequence tracking per scene
  consequences       Json?       // { created?: string[], resolved?: string[], relationshipChanges?: object[] }

  // Phase 9: Turn tracking
  turnDeadline       DateTime?
  waitingOnUsers     Json?       // Array of user IDs who need to act

  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  campaign      Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  playerActions PlayerAction[]
  diceRolls     DiceRoll[]
  turnOrder     TurnOrder?

  // Phase 8: Communication
  messages Message[]    @relation("SceneMessages")
  notes    PlayerNote[] @relation("SceneNotes")

  // Phase 9: Notifications
  notifications Notification[] @relation("SceneNotifications")
  turnTracker   TurnTracker[]  @relation("SceneTurnTracker")

  @@index([campaignId])
  @@index([status])
}

//
// PLAYER ACTIONS
//

model PlayerAction {
  id            String   @id @default(cuid())
  sceneId       String
  characterId   String
  userId        String
  actionText    String   @db.Text
  intentOutcome String?
  status        String   @default("pending")
  resolution    String?  @db.Text
  rollResult    Json?

  // PbtA move tracking
  moveUsed      String?  // Which move was triggered
  rollRequired  Boolean  @default(false) // Does this need a roll?
  rollMade      String?  // Link to DiceRoll.id if rolled

  // Phase 16: Exchange tracking
  exchangeNumber Int?    // Which exchange this action belongs to
  actionPriority Int?    @default(0) // For complex exchange ordering

  createdAt     DateTime @default(now())

  scene     Scene     @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sceneId])
  @@index([characterId])
}

//
// TIMELINE — FULL feature version
//

model TimelineEvent {
  id             String          @id @default(cuid())
  campaignId     String
  turnNumber     Int?                              // required by world turn + UI
  title          String
  summaryPublic  String?        @db.Text
  summaryGM      String?        @db.Text
  isOffscreen    Boolean?       @default(false)
  eventType      EventType?
  visibility     EventVisibility @default(PUBLIC)
  sessionDate    DateTime        @default(now())
  gmNotes        String?
  createdAt      DateTime        @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([turnNumber])
}

//
// WORLD META — FULL feature version
//

model WorldMeta {
  id               String   @id @default(cuid())
  campaignId       String   @unique
  currentTurnNumber Int      @default(1)
  currentInGameDate String?
  currentLocation   String?
  tension           Int      @default(50)
  phase             String?
  otherMeta         Json?
  gmNotes           String?
  updatedAt         DateTime @updatedAt

  // Phase 15: AI Health & Cost Tracking
  aiHealth              Json?     // Circuit breaker state and AI failure tracking
  aiMetrics             Json?     // Token usage, costs, response times
  campaignHealthHistory Json?     // Historical health scores and issues
  lastHealthCheck       DateTime? // Last time health was checked
  currentHealthScore    Int?      // Current campaign health (0-100)

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

//
// INVITES
//

model CampaignInvite {
  id         String   @id @default(cuid())
  campaignId String
  token      String   @unique @default(cuid())
  createdBy  String
  expiresAt  DateTime
  maxUses    Int      @default(0)
  uses       Int      @default(0)
  createdAt  DateTime @default(now())

  campaign       Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  createdByUser  User     @relation("InviteCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([campaignId])
}

//
// PHASE 7 ADDITIONS: PbtA System
//

model Move {
  id          String   @id @default(cuid())
  campaignId  String
  name        String
  trigger     String   // "When you..."
  description String   @db.Text
  rollType    String?  // "roll+cool", "roll+hard", "act under fire", null for no roll
  outcomes    Json     // {success: "...", partial: "...", miss: "..."}
  category    String   @default("basic") // "basic", "special", "custom"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign  Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  diceRolls DiceRoll[]

  @@index([campaignId])
}

model DiceRoll {
  id          String   @id @default(cuid())
  campaignId  String
  sceneId     String?
  characterId String
  userId      String

  rollType    String   // "move", "custom", "help", "interfere"
  moveId      String?  // If rolling a specific move

  dice        Int[]    // [6, 4] for 2d6 showing 6 and 4
  modifier    Int      @default(0) // Stat modifier or forward
  total       Int      // Sum of dice + modifier

  outcome     String   // "strongHit" (10+), "weakHit" (7-9), "miss" (6-)
  description String?  // Context for the roll

  forward     Int?     @default(0) // +1 forward granted
  ongoing     Int?     @default(0) // +1 ongoing granted
  hold        Int?     @default(0) // Hold generated

  isSecret    Boolean  @default(false) // Hidden from other players
  createdAt   DateTime @default(now())

  campaign  Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  scene     Scene?    @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  move      Move?     @relation(fields: [moveId], references: [id])

  @@index([campaignId])
  @@index([sceneId])
  @@index([characterId])
}

model TurnOrder {
  id         String   @id @default(cuid())
  sceneId    String   @unique

  // JSON array of {characterId, initiative, hasActed}
  order      Json     // [{characterId: "...", initiative: 12, hasActed: false}]

  currentTurn Int     @default(0) // Index in the order array
  roundNumber Int     @default(1)
  isActive    Boolean @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  scene      Scene      @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  characters Character[]

  @@index([sceneId])
}

//
// PHASE 8: COMMUNICATION MODELS
//

model Message {
  id         String      @id @default(cuid())
  content    String      @db.Text
  type       MessageType @default(OUT_OF_CHARACTER)
  authorId   String
  campaignId String
  sceneId    String?

  // For whisper/private messages
  targetUserId String?

  // Character context (for IC messages)
  characterId String?

  // Phase 9: Mention detection
  mentionsUserIds Json?    @default("[]")
  hasMentions     Boolean  @default(false)

  // Phase 9: Sound triggers
  triggerSound String?
  soundVolume  Float?   @default(1.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  author     User       @relation("UserMessages", fields: [authorId], references: [id], onDelete: Cascade)
  targetUser User?      @relation("UserWhispers", fields: [targetUserId], references: [id], onDelete: Cascade)
  campaign   Campaign   @relation("CampaignMessages", fields: [campaignId], references: [id], onDelete: Cascade)
  scene      Scene?     @relation("SceneMessages", fields: [sceneId], references: [id], onDelete: Cascade)
  character  Character? @relation("CharacterMessages", fields: [characterId], references: [id], onDelete: Cascade)

  @@index([campaignId, createdAt])
  @@index([campaignId, sceneId])
  @@map("messages")
}

model PlayerNote {
  id          String         @id @default(cuid())
  title       String
  content     String         @db.Text
  visibility  NoteVisibility @default(PRIVATE)
  authorId    String
  campaignId  String

  // Optional associations
  characterId String?
  npcId       String?
  factionId   String?
  sceneId     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  author    User       @relation("UserNotes", fields: [authorId], references: [id], onDelete: Cascade)
  campaign  Campaign   @relation("CampaignNotes", fields: [campaignId], references: [id], onDelete: Cascade)
  character Character? @relation("CharacterNotes", fields: [characterId], references: [id], onDelete: Cascade)
  npc       NPC?       @relation("NPCNotes", fields: [npcId], references: [id], onDelete: Cascade)
  faction   Faction?   @relation("FactionNotes", fields: [factionId], references: [id], onDelete: Cascade)
  scene     Scene?     @relation("SceneNotes", fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([campaignId, authorId])
  @@index([campaignId, visibility])
  @@map("player_notes")
}

//
// PHASE 9: NOTIFICATION MODELS
//

model Notification {
  id         String               @id @default(cuid())
  type       NotificationType
  title      String
  message    String               @db.Text
  status     NotificationStatus   @default(UNREAD)
  priority   NotificationPriority @default(NORMAL)

  // Recipients
  userId     String
  campaignId String?
  sceneId    String?

  // Metadata for rich notifications
  actionUrl String?
  metadata  Json?

  // Email/Push settings
  emailSent Boolean @default(false)
  pushSent  Boolean @default(false)

  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  readAt      DateTime?
  dismissedAt DateTime?

  // Relationships
  user     User      @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign? @relation("CampaignNotifications", fields: [campaignId], references: [id], onDelete: Cascade)
  scene    Scene?    @relation("SceneNotifications", fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([campaignId, type])
  @@index([createdAt])
  @@map("notifications")
}

model UserNotificationSettings {
  id     String @id @default(cuid())
  userId String @unique

  // Email notification preferences
  emailEnabled         Boolean @default(true)
  emailTurnReminders   Boolean @default(true)
  emailSceneChanges    Boolean @default(true)
  emailMentions        Boolean @default(true)
  emailWhispers        Boolean @default(true)
  emailCampaignInvites Boolean @default(true)
  emailWorldEvents     Boolean @default(false)

  // Browser push notification preferences
  pushEnabled         Boolean @default(true)
  pushTurnReminders   Boolean @default(true)
  pushSceneChanges    Boolean @default(true)
  pushMentions        Boolean @default(true)
  pushWhispers        Boolean @default(true)
  pushCampaignInvites Boolean @default(true)

  // Sound notification preferences
  soundEnabled         Boolean @default(true)
  soundTurnReminders   Boolean @default(true)
  soundSceneChanges    Boolean @default(true)
  soundMentions        Boolean @default(true)
  soundWhispers        Boolean @default(true)
  soundCriticalMoments Boolean @default(true)
  soundWorldEvents     Boolean @default(true)

  // Timing preferences
  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String? // "22:00"
  quietHoursEnd     String? // "08:00"
  timezone          String? // "America/New_York"

  // Digest preferences
  dailyDigestEnabled  Boolean @default(false)
  weeklyDigestEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user User @relation("UserNotificationSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_settings")
}

model TurnTracker {
  id         String @id @default(cuid())
  campaignId String
  sceneId    String?

  // Turn order and timing
  currentTurn        Int       @default(0)
  turnOrder          Json // Array of character/player IDs
  turnStartedAt      DateTime?
  turnDeadline       DateTime?
  autoAdvanceTurn    Boolean   @default(false)
  turnTimeoutMinutes Int       @default(60)

  // Notifications sent
  remindersSent    Json      @default("[]") // Array of timestamps
  lastReminderSent DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  campaign Campaign @relation("CampaignTurnTracker", fields: [campaignId], references: [id], onDelete: Cascade)
  scene    Scene?   @relation("SceneTurnTracker", fields: [sceneId], references: [id], onDelete: Cascade)

  @@unique([campaignId, sceneId])
  @@map("turn_trackers")
}

//
// PHASE 10.5: AI VISUAL GENERATION MODELS
//

model Map {
  id          String   @id @default(cuid())
  campaignId  String
  sceneId     String?
  name        String
  description String?  @db.Text
  width       Int      @default(800)
  height      Int      @default(600)
  gridSize    Int      @default(40)
  background  String?  // Color or image URL
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  zones  Zone[]
  tokens Token[]

  @@index([campaignId])
  @@index([sceneId])
  @@map("maps")
}

model Zone {
  id          String  @id @default(cuid())
  mapId       String
  name        String
  description String? @db.Text
  x           Int
  y           Int
  width       Int
  height      Int
  color       String? @default("#3b82f6")
  isActive    Boolean @default(true)
  metadata    Json?   // For additional properties

  map Map @relation(fields: [mapId], references: [id], onDelete: Cascade)

  @@index([mapId])
  @@map("zones")
}

model Token {
  id        String  @id @default(cuid())
  mapId     String
  name      String
  x         Int
  y         Int
  color     String  @default("#ef4444")
  size      Int     @default(30)
  isPlayer  Boolean @default(false)
  isVisible Boolean @default(true)
  metadata  Json?   // For character ID, NPC ID, etc.

  map Map @relation(fields: [mapId], references: [id], onDelete: Cascade)

  @@index([mapId])
  @@map("tokens")
}

model CampaignImage {
  id         String   @id @default(cuid())
  campaignId String
  url        String
  prompt     String?  @db.Text
  tags       String[]
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([campaignId])
  @@map("campaign_images")
}

//
// PHASE 11: SESSION & DOWNTIME MODELS
//

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ActivityStatus {
  ACTIVE
  COMPLETED
  FAILED
  CANCELLED
}

model Session {
  id          String        @id @default(cuid())
  campaignId  String
  name        String
  description String?       @db.Text
  sessionNumber Int
  status      SessionStatus @default(SCHEDULED)
  scheduledAt DateTime?
  startTime   DateTime?     // Keep for compatibility
  startedAt   DateTime?     // Add for service compatibility
  endTime     DateTime?     // Keep for compatibility
  endedAt     DateTime?     // Add for service compatibility
  duration    Int?          // In minutes
  objectives  String[]
  experienceAwarded Int     @default(0)
  goldAwarded Int           @default(0)
  itemsAwarded String[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  participants SessionParticipant[]
  scenes       SessionScene[]
  notes        SessionNote[]

  @@index([campaignId])
  @@index([status])
  @@map("sessions")
}

model SessionParticipant {
  id            String   @id @default(cuid())
  sessionId     String
  characterId   String
  userId        String
  joinedAt      DateTime @default(now())
  leftAt        DateTime?
  wasPresent    Boolean  @default(true)
  attendanceStatus String @default("PRESENT") // PRESENT, ABSENT, LATE, LEFT_EARLY
  actionsCount  Int      @default(0)
  messagesCount Int      @default(0)
  notes         String?  @db.Text

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, characterId])
  @@index([sessionId])
  @@map("session_participants")
}

model SessionScene {
  id          String   @id @default(cuid())
  sessionId   String
  sceneId     String
  orderIndex  Int
  duration    Int?     // In minutes
  summary     String?  @db.Text
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  notes       String?  @db.Text

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("session_scenes")
}

model SessionNote {
  id        String   @id @default(cuid())
  sessionId String
  authorId  String
  content   String   @db.Text
  noteType  String   @default("general") // general, highlight, decision, npc
  isPublic  Boolean  @default(true)
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("session_notes")
}

model DowntimeActivity {
  id              String         @id @default(cuid())
  characterId     String
  description     String         @db.Text // Natural language description
  summary         String         @db.Text // AI-generated summary
  status          ActivityStatus @default(ACTIVE)

  // AI-determined properties
  estimatedDays   Int
  currentDay      Int            @default(0)
  costs           Json?          // {gold: 100, resources: [...]}
  requirements    String[]       // Prerequisites
  skillsInvolved  String[]       // Skills being used
  riskLevel       String?        // low, medium, high

  outcomes        Json?          // Potential outcomes
  finalOutcome    String?        @db.Text

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  completedAt     DateTime?

  events DowntimeEvent[]

  @@index([characterId])
  @@index([status])
  @@map("downtime_activities")
}

model DowntimeEvent {
  id         String   @id @default(cuid())
  activityId String
  dayNumber  Int
  eventText  String   @db.Text // AI-generated event
  choices    Json?    // Available choices
  response   String?  @db.Text // Player response
  outcome    String?  @db.Text // Result of response
  createdAt  DateTime @default(now())
  respondedAt DateTime?

  activity DowntimeActivity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@map("downtime_events")
}

//
// PHASE 16.5: TUTORIAL & ONBOARDING
//

enum TutorialStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

model TutorialStep {
  id            String   @id @default(cuid())
  stepKey       String   @unique // e.g., "create_character", "first_action"
  title         String
  description   String   @db.Text
  category      String   // "basics", "combat", "social", "advanced"
  orderIndex    Int
  isOptional    Boolean  @default(false)
  prerequisites String[] // Array of stepKeys that must be completed first

  // Interactive tutorial data
  contentBlocks Json?    // Array of content blocks with type, text, images
  targetElement String?  // CSS selector for highlighting
  tooltipPosition String? @default("bottom") // top, bottom, left, right

  // Completion criteria
  completionTrigger String? // e.g., "submit_action", "create_character"
  validationRules   Json?   // Rules to check if step is complete

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userProgress UserTutorialProgress[]

  @@index([category, orderIndex])
  @@map("tutorial_steps")
}

model UserTutorialProgress {
  id          String         @id @default(cuid())
  userId      String
  stepId      String
  status      TutorialStatus @default(NOT_STARTED)
  startedAt   DateTime?
  completedAt DateTime?
  skippedAt   DateTime?

  // User's interaction data
  attemptsCount Int @default(0)
  hintsViewed   Int @default(0)
  timeSpent     Int @default(0) // In seconds

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  step TutorialStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@unique([userId, stepId])
  @@index([userId, status])
  @@map("user_tutorial_progress")
}

model CampaignTutorialMode {
  id          String  @id @default(cuid())
  campaignId  String  @unique
  isEnabled   Boolean @default(true)

  // Tutorial campaign settings
  useGuidedScenes    Boolean @default(true)
  showTooltips       Boolean @default(true)
  provideHints       Boolean @default(true)
  allowSkip          Boolean @default(true)

  // Progress tracking
  currentStepKey String?
  completedSteps String[] // Array of stepKeys

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("campaign_tutorial_mode")
}

//
// PHASE 25: SAFETY TOOLS & CONTENT MODERATION
//

enum ContentWarningType {
  VIOLENCE
  SEXUAL_CONTENT
  GORE
  HORROR
  SUBSTANCE_ABUSE
  MENTAL_HEALTH
  DISCRIMINATION
  DEATH
  TRAUMA
  CUSTOM
}

enum XCardTrigger {
  SCENE_CONTENT
  MESSAGE
  CHARACTER_ACTION
  NPC_BEHAVIOR
  GENERAL
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
}

enum ReportSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model CampaignSafetySettings {
  id         String   @id @default(cuid())
  campaignId String   @unique

  // X-Card settings
  xCardEnabled          Boolean @default(true)
  anonymousXCard        Boolean @default(true) // Don't show who used X-Card
  pauseOnXCard          Boolean @default(true)
  xCardNotifyGMOnly     Boolean @default(false)

  // Content warnings
  contentWarningsEnabled Boolean @default(true)
  activeWarnings         Json    @default("[]") // Array of ContentWarningType

  // Lines and Veils (pre-game safety discussion)
  lines                 String[] // Hard boundaries - will not be included
  veils                 String[] // Soft boundaries - will be implied, not detailed

  // Session Zero settings
  sessionZeroCompleted  Boolean  @default(false)
  sessionZeroDate       DateTime?
  sessionZeroNotes      String?  @db.Text

  // Content moderation
  autoModeration        Boolean  @default(false)
  moderationLevel       String   @default("medium") // low, medium, high

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("campaign_safety_settings")
}

model XCardUse {
  id         String       @id @default(cuid())
  campaignId String
  sceneId    String?
  userId     String

  trigger    XCardTrigger
  targetId   String?      // ID of message, action, scene, etc.
  reason     String?      @db.Text // Optional explanation
  isAnonymous Boolean     @default(true)

  // GM/Moderator response
  acknowledged  Boolean   @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolution    String?   @db.Text

  createdAt  DateTime @default(now())

  @@index([campaignId, createdAt])
  @@index([sceneId])
  @@map("x_card_uses")
}

model ContentReport {
  id          String         @id @default(cuid())
  reporterId  String
  campaignId  String

  // What's being reported
  contentType String         // "message", "note", "character", "scene", "user_behavior"
  contentId   String?
  contentText String?        @db.Text

  reason      String         @db.Text
  category    String?        // harassment, inappropriate_content, cheating, other
  severity    ReportSeverity @default(MEDIUM)
  status      ReportStatus   @default(PENDING)

  // Moderation
  reviewedBy  String?
  reviewedAt  DateTime?
  resolution  String?        @db.Text
  actionTaken String?        // warning, content_removed, user_banned, dismissed

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([campaignId, status])
  @@index([reporterId])
  @@index([status, severity])
  @@map("content_reports")
}

model UserBlock {
  id            String   @id @default(cuid())
  userId        String   // User doing the blocking
  blockedUserId String   // User being blocked
  campaignId    String?  // Optional: block only in specific campaign
  reason        String?  @db.Text

  createdAt     DateTime @default(now())

  @@unique([userId, blockedUserId, campaignId])
  @@index([userId])
  @@index([blockedUserId])
  @@map("user_blocks")
}

model CampaignBan {
  id         String   @id @default(cuid())
  campaignId String
  userId     String
  bannedBy   String   // GM/Admin who issued the ban
  reason     String   @db.Text
  isPermanent Boolean @default(false)
  expiresAt  DateTime?

  createdAt  DateTime @default(now())

  @@unique([campaignId, userId])
  @@index([userId])
  @@map("campaign_bans")
}

//
// PAYMENT & TRANSACTION TRACKING
//

enum TransactionType {
  CREDIT        // User added funds
  DEBIT         // AI usage charge
  REFUND        // Refund issued
  ADJUSTMENT    // Manual adjustment
}

model Transaction {
  id            String          @id @default(cuid())
  userId        String
  type          TransactionType
  amount        Int             // In cents (positive for credit, negative for debit)
  balanceBefore Int             // Balance before transaction
  balanceAfter  Int             // Balance after transaction
  description   String
  metadata      Json?           // Additional info (e.g., sceneId, tokens used, etc.)
  createdAt     DateTime        @default(now())

  @@index([userId, createdAt])
  @@map("transactions")
}

//
// CAMPAIGN LOG & PROGRESSION TRACKING
//

model CampaignLog {
  id          String   @id @default(cuid())
  campaignId  String
  sceneId     String?  // Optional link to specific scene
  turnNumber  Int

  // Content
  title       String
  summary     String   @db.Text // AI-generated summary of what happened
  highlights  String[] // Key events or important moments
  entryType   String   @default("scene") // scene, downtime, world_event, milestone

  // Timeline tracking
  inGameDate  String?  // Optional in-game date/time
  duration    String?  // How much in-game time passed (e.g., "2 hours", "3 days")

  createdAt   DateTime @default(now())

  @@index([campaignId, turnNumber])
  @@index([sceneId])
  @@map("campaign_logs")
}

//
// CAMPAIGN WIKI & KNOWLEDGE BASE
//

enum WikiEntryType {
  NPC
  FACTION
  LOCATION
  CLOCK
  ITEM
  QUEST
  LORE
  CUSTOM
}

model WikiEntry {
  id          String        @id @default(cuid())
  campaignId  String
  entryType   WikiEntryType

  // Basic info
  name        String
  summary     String        @db.Text  // Short description
  description String        @db.Text  // Full details

  // Metadata
  tags        String[]      // For filtering/searching
  aliases     String[]      // Alternative names
  imageUrl    String?       // Optional image

  // Relationships
  relatedEntries Json?       // Array of {id, type, relationship} to link entries

  // Status tracking
  isActive    Boolean       @default(true)
  lastSeenTurn Int?         // Last turn this was mentioned/updated
  importance  String        @default("normal") // minor, normal, major, critical

  // History
  changelog   Json?         // Array of {turn, change, summary} for tracking updates

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   String        @default("ai") // ai or userId

  @@index([campaignId, entryType])
  @@index([campaignId, name])
  @@index([campaignId, isActive])
  @@map("wiki_entries")
}
